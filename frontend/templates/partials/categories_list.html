<div class="mb-6">
  <h3 class="font-semibold text-blue-400 mb-3 text-lg flex items-center">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
    </svg>
    Kategorie
  </h3>
  
  <div class="flex flex-wrap gap-2 mb-4" id="categories-column">
    <!-- Opcja "Wszystkie kategorie" -->
    <button 
      data-category-id="null"
      class="category-btn bg-gray-700 border border-gray-600 hover:border-blue-400 rounded-lg px-4 py-2 transition-all duration-200 hover:bg-gray-600"
      hx-get="/emails?mode=html"
      hx-target="#emails-column"
      hx-swap="innerHTML">
      <div class="font-semibold text-blue-300 whitespace-nowrap">Wszystkie maile</div>
    </button>

    {% for category in categories %}
      <div class="relative group">
        <button 
          data-category-id="{{ category.name }}"
          class="category-btn bg-gray-700 border border-gray-600 hover:border-blue-400 rounded-lg px-4 py-2 transition-all duration-200 hover:bg-gray-600"
          hx-get="/emails?category={{ category.name }}&mode=html"
          hx-target="#emails-column"
          hx-swap="innerHTML"
          onclick="setCurrentCategory('{{ category.name }}')">
          <div class="font-medium text-blue-300 whitespace-nowrap">{{ category.name }}</div>
        </button>
        <button 
          hx-delete="/categories/{{ category.id }}" 
          hx-confirm="Na pewno chcesz usunąć kategorię '{{ category.name }}'?"
          hx-target="#categories-column"
          hx-swap="innerHTML"
          class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity duration-200 flex items-center justify-center">
          ✖
        </button>
      </div>
    {% else %}
      <div class="text-center py-4 w-full">
        <p class="text-gray-500 text-sm">Brak kategorii</p>
      </div>
    {% endfor %}
  </div>

  <form
    hx-post="/categories/add_user_category"
    hx-target="#categories-column"
    hx-swap="innerHTML"
    hx-on::after-request="if(event.detail.successful) this.reset()"
    class="flex space-x-2">
    <input
        type="text"
        name="category_name"
        placeholder="Nowa kategoria"
        required
        class="flex-grow bg-gray-700 text-gray-200 rounded-lg border border-gray-600 focus:border-blue-400 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 placeholder-gray-400"
    />
    <button
        type="submit"
        class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
        Dodaj
    </button>
  </form>
</div>

<script>
let selectedCategory = null;

function highlightSelectedCategory() {
  document.querySelectorAll('.category-btn').forEach(btn => {
    btn.classList.remove('bg-blue-500', 'border-blue-400', 'hover:bg-gray-600');
    btn.classList.add('bg-gray-700', 'border-gray-600', 'hover:bg-gray-600');
  });

  const idToSelect = selectedCategory === null ? 'null' : selectedCategory;

  const btn = document.querySelector(`[data-category-id="${idToSelect}"]`);
  if (btn) {
    btn.classList.remove('bg-gray-700', 'border-gray-600', 'hover:bg-gray-600');
    btn.classList.add('bg-blue-500', 'border-blue-400');
  }
}

// Kliknięcie przycisku -> zapamiętaj i podświetl
document.addEventListener('click', e => {
  const btn = e.target.closest('.category-btn');
  if (btn) {
    selectedCategory = btn.getAttribute('data-category-id');
    highlightSelectedCategory();
  }
});

// Po podmianie przez HTMX -> odtwórz podświetlenie
document.body.addEventListener('htmx:afterSwap', highlightSelectedCategory);

// Domyślnie podświetl "Wszystkie maile" na start
document.addEventListener('DOMContentLoaded', () => {
  selectedCategory = "null";
  highlightSelectedCategory();
});
</script>
