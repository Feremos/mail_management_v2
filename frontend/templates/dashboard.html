<style>
  a.selected {
    background-color: #3b82f6; /* niebieskie tło pasujące do ciemnego motywu */
    color: white !important;
  }
  
  .email-item:hover {
    background-color: #2d3748 !important;
    transition: background-color 0.2s ease;
  }
  
  .scrollbar-custom::-webkit-scrollbar {
    width: 8px;
  }
  
  .scrollbar-custom::-webkit-scrollbar-track {
    background: #1a202c;
  }
  
  .scrollbar-custom::-webkit-scrollbar-thumb {
    background-color: #4a5568;
    border-radius: 4px;
  }
</style>

{% extends "base.html" %}

{% block content %}
<div class="flex flex-grow h-full bg-gray-900 text-gray-200">

    <!-- LEWA KOLUMNA -->
    <aside class="w-1/4 border-r border-gray-700 p-6 flex flex-col bg-gray-800 h-full">
        <div id="inboxes-column"
             hx-get="/inboxes/selected?mode=html"
             hx-trigger="load"
             hx-target="#inboxes-column"
             class="overflow-auto scrollbar-custom text-blue-300 font-medium mb-6 space-y-1">
            <div class="animate-pulse flex space-x-4">
              <div class="flex-1 space-y-2 py-1">
                <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                <div class="h-4 bg-gray-700 rounded"></div>
                <div class="h-4 bg-gray-700 rounded w-5/6"></div>
              </div>
            </div>
        </div>

        
        <div id="categories-column"
             hx-get="/categories?mode=html"
             hx-trigger="load"
             hx-target="#categories-column"
             class="overflow-auto scrollbar-custom text-blue-300 font-medium mb-6 space-y-1">
            <div class="animate-pulse flex space-x-4">
              <div class="flex-1 space-y-2 py-1">
                <div class="h-4 bg-gray-700 rounded w-3/4"></div>
                <div class="h-4 bg-gray-700 rounded"></div>
                <div class="h-4 bg-gray-700 rounded w-5/6"></div>
              </div>
            </div>
        </div>

        <hr class="my-6 border-gray-700" />
        <div class="mb-4">
            <button 
                hx-post="/emails/fetch?mode=html"
                hx-target="#emails-column"
                hx-swap="innerHTML"
                class="w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                </svg>
                Odśwież maile
            </button>
        </div>
        <form action="/users/logout" method="POST" class="mt-auto">
            <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-500 transition text-white font-semibold py-3 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400 flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" />
              </svg>
              Wyloguj
            </button>
        </form>
    </aside>

    <!-- ŚRODKOWA KOLUMNA -->
    <section class="w-1/3 border-r border-gray-700 p-6 overflow-auto bg-gray-800">
        <h2 class="text-lg font-semibold text-blue-400 mb-4 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
            <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
          </svg>
          Wiadomości
        </h2>
        <div id="emails-column"
            hx-get="/emails?mode=html"
            hx-trigger="load"
            hx-swap="innerHTML"
            class="font-normal scrollbar-custom">
            <p class="text-gray-500 italic">Wybierz skrzynkę lub kategorię z lewej strony</p>
        </div>
    </section>

    <!-- PRAWA KOLUMNA -->
    <section class="flex-1 p-6 overflow-auto bg-gray-800 scrollbar-custom">
        <h2 class="text-lg font-semibold text-blue-400 mb-4 flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          Szczegóły
        </h2>
        <div id="email-detail" class="font-normal text-gray-300">
            <p class="text-gray-500 italic">Wybierz wiadomość z listy</p>
        </div>
    </section>
</div>

<script>
// Śledzenie aktualnych filtrów
let currentInbox = null;
let currentCategory = null;

function setCurrentInbox(inboxId) {
    currentInbox = inboxId;
    updateFilters();
}

function setCurrentCategory(category) {
    currentCategory = category;
    updateFilters();
}

function updateFilters() {
    // Buduj URL z aktualnych filtrów
    let url = '/emails?mode=html';
    
    if (currentInbox) {
        url += '&inbox_id=' + currentInbox;
    }
    
    if (currentCategory) {
        url += '&category=' + encodeURIComponent(currentCategory);
    }
    
    // Aktualizuj wszystkie przyciski żeby używały kombinacji filtrów
    updateButtonUrls();
}

function updateButtonUrls() {
    // Aktualizuj przyciski kategorii żeby zachowały inbox
    document.querySelectorAll('[data-category-btn]').forEach(btn => {
        const category = btn.getAttribute('data-category');
        let url = '/emails?mode=html';
        
        if (currentInbox) {
            url += '&inbox_id=' + currentInbox;
        }
        
        if (category && category !== 'null') {
            url += '&category=' + encodeURIComponent(category);
        }
        
        btn.setAttribute('hx-get', url);
    });
    
    // Aktualizuj przyciski inboxów żeby zachowały kategorię
    document.querySelectorAll('[data-inbox-btn]').forEach(btn => {
        const inboxId = btn.getAttribute('data-inbox');
        let url = '/emails?mode=html';
        
        if (inboxId && inboxId !== 'null') {
            url += '&inbox_id=' + inboxId;
        }
        
        if (currentCategory) {
            url += '&category=' + encodeURIComponent(currentCategory);
        }
        
        btn.setAttribute('hx-get', url);
    });
}

document.body.addEventListener('htmx:afterSwap', (event) => {
  if(event.target.id === 'emails-column'){
    // znajdź pierwszy link maila
    const firstEmailLink = document.querySelector('#emails-column ul li a');
    if(firstEmailLink){
      // usuń klasę selected z innych
      document.querySelectorAll('#emails-column ul li a').forEach(a => a.classList.remove('selected'));
      // dodaj selected do pierwszego
      firstEmailLink.classList.add('selected');
      // kliknij, żeby załadować szczegóły
      const url = firstEmailLink.getAttribute('hx-get');
      htmx.ajax('GET', url, {target: '#email-detail', swap: 'innerHTML'});
    }
  }
});

// Dodatkowo: po kliknięciu na maila, podświetl go
document.querySelector('#emails-column').addEventListener('click', e => {
  const a = e.target.closest('a');
  if(!a) return;
  // usuwaj selected z innych
  document.querySelectorAll('#emails-column ul li a').forEach(link => link.classList.remove('selected'));
  a.classList.add('selected');
});
</script>

{% endblock %}
