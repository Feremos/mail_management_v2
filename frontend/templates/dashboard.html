<style>
a.selected {
  background-color: #bfdbfe; /* jasnoniebieskie tło */
}
</style>
{% extends "base.html" %}

{% block content %}

<div class="flex flex-grow h-full">

    <!-- LEWA KOLUMNA -->
    <aside style="width: 25%;" class="border-r border-blue-200 p-6 flex flex-col bg-blue-50 h-full">
        <div id="inboxes-column"
             hx-get="/inboxes/selected?mode=html"
             hx-trigger="load"
             hx-target="#inboxes-column"
             class="overflow-auto scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 text-blue-800 font-medium mb-6">
            Ładowanie skrzynek...
        </div>

        <div id="categories-column"
             hx-get="/categories?mode=html"
             hx-trigger="load"
             hx-target="#categories-column"
             class="overflow-auto scrollbar-thin scrollbar-thumb-blue-300 scrollbar-track-blue-100 text-blue-800 font-medium mb-6">
            Ładowanie kategorii...
        </div>

        <hr class="my-6 border-blue-200" />

        <form action="/users/logout" method="POST" class="mt-auto">
            <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 transition text-white font-semibold py-3 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                Wyloguj
            </button>
        </form>
    </aside>

    <!-- ŚRODEK -->
    <section style="width: 30%;" class="border-r border-blue-200 p-6 overflow-auto">
        <div id="emails-column"
            hx-get="/emails?mode=html"
            hx-trigger="load"
            hx-swap="innerHTML"
            class="text-blue-900 font-normal">
        <p class="text-blue-300 italic">Wybierz skrzynkę lub kategorię z lewej strony</p>
        </div>
    </section>

    <!-- PRAWA -->
    <section style="width: 65%;" class="flex-1 p-6 overflow-auto">
        <div id="email-detail" class="text-blue-900 font-normal">
            <p class="text-blue-300 italic">Wybierz wiadomość z listy</p>
        </div>
    </section>

</div>

<script>
// Śledzenie aktualnych filtrów
let currentInbox = null;
let currentCategory = null;

function setCurrentInbox(inboxId) {
    currentInbox = inboxId;
    updateFilters();
}

function setCurrentCategory(category) {
    currentCategory = category;
    updateFilters();
}

function updateFilters() {
    // Buduj URL z aktualnych filtrów
    let url = '/emails?mode=html';
    
    if (currentInbox) {
        url += '&inbox_id=' + currentInbox;
    }
    
    if (currentCategory) {
        url += '&category=' + encodeURIComponent(currentCategory);
    }
    
    // Aktualizuj wszystkie przyciski żeby używały kombinacji filtrów
    updateButtonUrls();
}

function updateButtonUrls() {
    // Aktualizuj przyciski kategorii żeby zachowały inbox
    document.querySelectorAll('[data-category-btn]').forEach(btn => {
        const category = btn.getAttribute('data-category');
        let url = '/emails?mode=html';
        
        if (currentInbox) {
            url += '&inbox_id=' + currentInbox;
        }
        
        if (category && category !== 'null') {
            url += '&category=' + encodeURIComponent(category);
        }
        
        btn.setAttribute('hx-get', url);
    });
    
    // Aktualizuj przyciski inboxów żeby zachowały kategorię
    document.querySelectorAll('[data-inbox-btn]').forEach(btn => {
        const inboxId = btn.getAttribute('data-inbox');
        let url = '/emails?mode=html';
        
        if (inboxId && inboxId !== 'null') {
            url += '&inbox_id=' + inboxId;
        }
        
        if (currentCategory) {
            url += '&category=' + encodeURIComponent(currentCategory);
        }
        
        btn.setAttribute('hx-get', url);
    });
}

document.body.addEventListener('htmx:afterSwap', (event) => {
  if(event.target.id === 'emails-column'){
    // znajdź pierwszy link maila
    const firstEmailLink = document.querySelector('#emails-column ul li a');
    if(firstEmailLink){
      // usuń klasę selected z innych
      document.querySelectorAll('#emails-column ul li a').forEach(a => a.classList.remove('selected'));
      // dodaj selected do pierwszego
      firstEmailLink.classList.add('selected');
      // kliknij, żeby załadować szczegóły
      const url = firstEmailLink.getAttribute('hx-get');
      htmx.ajax('GET', url, {target: '#email-detail', swap: 'innerHTML'});

    }
  }
});


// Dodatkowo: po kliknięciu na maila, podświetl go

document.querySelector('#emails-column').addEventListener('click', e => {
  const a = e.target.closest('a');
  if(!a) return;
  // usuwaj selected z innych
  document.querySelectorAll('#emails-column ul li a').forEach(link => link.classList.remove('selected'));
  a.classList.add('selected');
});


</script>

{% endblock %}